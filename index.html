<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEOæœ€é©åŒ– -->
  <title>ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ - å…¨å›½200+ãƒ€ãƒ ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è²¯æ°´ç‡ãƒ»æ°´ä½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</title>
  <meta name="description" content="å…¨å›½200ä»¥ä¸Šã®ãƒ€ãƒ ã®è²¯æ°´ç‡ãƒ»æ°´ä½ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã€‚å›½åœŸäº¤é€šçœãƒ»æ°´è³‡æºæ©Ÿæ§‹ãƒ»è‡ªæ²»ä½“ç®¡ç†ãƒ€ãƒ ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åœ°å›³ã¨ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã€‚é˜²ç½ãƒ»æ°´è³‡æºç®¡ç†ã«å½¹ç«‹ã¤ãƒ€ãƒ æƒ…å ±ã‚µã‚¤ãƒˆã€‚" />
  <meta name="keywords" content="ãƒ€ãƒ ,è²¯æ°´ç‡,æ°´ä½,ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ,ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°,å…¨å›½,é˜²ç½,æ°´è³‡æº,å›½åœŸäº¤é€šçœ,æ°´è³‡æºæ©Ÿæ§‹,åˆ©æ ¹å·,æ·€å·,æ—©æ˜æµ¦ãƒ€ãƒ ,å…«ãƒƒå ´ãƒ€ãƒ " />
  <meta name="author" content="ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ" />
  <link rel="canonical" href="https://okaspo.github.io/dam-aggregator/" />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://okaspo.github.io/dam-aggregator/" />
  <meta property="og:title" content="ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ - å…¨å›½200+ãƒ€ãƒ ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è²¯æ°´ç‡ãƒ»æ°´ä½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°" />
  <meta property="og:description" content="å…¨å›½200ä»¥ä¸Šã®ãƒ€ãƒ ã®è²¯æ°´ç‡ãƒ»æ°´ä½ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã€‚å›½åœŸäº¤é€šçœãƒ»æ°´è³‡æºæ©Ÿæ§‹ãƒ»è‡ªæ²»ä½“ç®¡ç†ãƒ€ãƒ ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åœ°å›³ã¨ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã€‚" />
  <meta property="og:image" content="https://okaspo.github.io/dam-aggregator/og-image.png" />
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:site_name" content="ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://okaspo.github.io/dam-aggregator/" />
  <meta name="twitter:title" content="ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ - å…¨å›½200+ãƒ€ãƒ ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è²¯æ°´ç‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°" />
  <meta name="twitter:description" content="å…¨å›½200ä»¥ä¸Šã®ãƒ€ãƒ ã®è²¯æ°´ç‡ãƒ»æ°´ä½ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã€‚é˜²ç½ãƒ»æ°´è³‡æºç®¡ç†ã«å½¹ç«‹ã¤ãƒ€ãƒ æƒ…å ±ã‚µã‚¤ãƒˆã€‚" />
  <meta name="twitter:image" content="https://okaspo.github.io/dam-aggregator/twitter-card.png" />

  <!-- ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– -->
  <meta name="theme-color" content="#667eea" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ" />
  <style>
    :root{
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-light: #f8fafc;
      --bg-card: rgba(255, 255, 255, 0.95);
      --bd: rgba(226, 232, 240, 0.8);
      --fg: #1e293b;
      --muted: #64748b;
      --chip: rgba(248, 250, 252, 0.8);
      --green: #10b981;
      --yellow: #f59e0b;
      --orange: #f97316;
      --red: #ef4444;
      --gray: #94a3b8;
      --blue: #3b82f6;
      --purple: #8b5cf6;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }

    [data-theme="dark"] {
      --bg-gradient: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      --bg-light: #0f172a;
      --bg-card: rgba(30, 41, 59, 0.95);
      --bd: rgba(51, 65, 85, 0.8);
      --fg: #f1f5f9;
      --muted: #94a3b8;
      --chip: rgba(30, 41, 59, 0.8);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: var(--fg);
      background: var(--bg-light);
      background-image: var(--bg-gradient);
      background-attachment: fixed;
      line-height: 1.6;
      transition: all 0.3s ease;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ - Glass Morphism */
    header {
      padding: 1rem 1.5rem;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--bd);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    [data-theme="dark"] .logo {
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« */
    .theme-toggle {
      margin-left: auto;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      background: var(--chip);
      border: 1px solid var(--bd);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }

    .theme-toggle:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow);
    }

    .filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--muted);
    }

    /* ãƒãƒƒãƒ— - Glass Morphism */
    .chip {
      background: var(--chip);
      backdrop-filter: blur(10px);
      border: 1px solid var(--bd);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .chip:hover {
      box-shadow: var(--shadow);
      transform: translateY(-1px);
    }

    select, input[type="number"], input[type="text"] {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--bd);
      border-radius: 0.75rem;
      background: var(--bg-card);
      color: var(--fg);
      transition: all 0.3s ease;
      font-family: inherit;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    fieldset {
      border: 1px solid var(--bd);
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: var(--chip);
    }

    legend {
      font-size: 0.875rem;
      color: var(--muted);
      padding: 0 0.5rem;
      font-weight: 500;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    #main {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 1.5rem;
      padding: 1.5rem;
      max-width: 1800px;
      margin: 0 auto;
    }

    @media (max-width: 1024px) {
      #main {
        grid-template-columns: 1fr;
      }
    }

    /* åœ°å›³ - ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    #map {
      height: 600px;
      border-radius: 1.5rem;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      background: var(--bg-card);
      border: 1px solid var(--bd);
    }

    /* ãƒªã‚¹ãƒˆ - Glass Morphism */
    #list {
      max-height: 600px;
      overflow: auto;
      border-radius: 1.5rem;
      padding: 1rem;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--bd);
    }

    #list::-webkit-scrollbar {
      width: 8px;
    }

    #list::-webkit-scrollbar-track {
      background: transparent;
    }

    #list::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }

    #list::-webkit-scrollbar-thumb:hover {
      background: var(--purple);
    }

    /* ãƒ€ãƒ ã‚¢ã‚¤ãƒ†ãƒ  - ãƒ¢ãƒ€ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .item {
      border-bottom: 1px solid var(--bd);
      padding: 1rem 0.5rem;
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .item:hover {
      background: var(--chip);
      transform: translateX(4px);
      box-shadow: var(--shadow);
    }

    .item h4 {
      margin: 0 0 0.5rem 0;
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--fg);
    }

    .meta {
      font-size: 0.875rem;
      color: var(--muted);
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      border-radius: 0.5rem;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid var(--bd);
      background: var(--bg-card);
      margin-left: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .row-line {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: space-between;
    }

    /* è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    #detail {
      padding: 1.5rem;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      margin: 1.5rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--bd);
    }

    #detail-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #chart {
      max-width: 100%;
      border-radius: 1rem;
      padding: 1rem;
    }

    /* ãƒœã‚¿ãƒ³ - ãƒ¢ãƒ€ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn {
      padding: 0.625rem 1.25rem;
      border: 1px solid var(--bd);
      border-radius: 0.75rem;
      background: var(--bg-card);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      color: var(--fg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      font-family: inherit;
    }

    .btn:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-chip {
      border-radius: 9999px;
      padding: 0.5rem 1.25rem;
      border: 1px solid var(--bd);
      background: var(--bg-card);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      color: var(--fg);
      font-size: 0.875rem;
    }

    .btn-chip:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-chip.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      box-shadow: var(--shadow);
    }

    /* ã‚¢ãƒ©ãƒ¼ãƒˆ - ãƒ¢ãƒ€ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    #alerts {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      padding: 1.5rem;
      margin: 1.5rem;
      border-radius: 1.5rem;
      box-shadow: var(--shadow-lg);
    }

    #alerts h4 {
      color: #92400e;
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    footer {
      padding: 2rem;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      font-size: 0.875rem;
      color: var(--muted);
      text-align: center;
      border-top: 1px solid var(--bd);
      margin-top: 2rem;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
    #mini-tip {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: #fff;
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-lg);
      transform: translate(-50%, -130%);
      white-space: nowrap;
      display: none;
      font-weight: 500;
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .item {
      animation: fadeIn 0.3s ease;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
    @media (max-width: 768px) {
      header {
        padding: 1rem;
      }

      .logo {
        font-size: 1.25rem;
      }

      #main {
        padding: 1rem;
        gap: 1rem;
      }

      #map {
        height: 400px;
      }

      #list {
        max-height: 400px;
      }
    }

    /* AdSenseåºƒå‘Šã‚¹ã‚¿ã‚¤ãƒ« */
    .ad-container {
      margin: 1.5rem auto;
      padding: 1rem;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      border: 1px solid var(--bd);
      box-shadow: var(--shadow);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100px;
    }

    .ad-label {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
      margin-bottom: 0.5rem;
    }
  </style>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3008545198706381"
     crossorigin="anonymous"></script>
</head>
<body data-theme="light">
<header>
  <div class="logo">ğŸ’§ ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ</div>
  <div class="filters">
    <input id="q" placeholder="ãƒ€ãƒ å/æ²³å·å æ¤œç´¢" class="chip" style="min-width:220px;" />
    <label class="chip">éƒ½é“åºœçœŒ
      <select id="pref" multiple size="5" style="min-width:140px;margin-left:6px;"></select>
    </label>
    <label class="chip">æ²³å·
      <select id="river" multiple size="5" style="min-width:140px;margin-left:6px;"></select>
    </label>
    <label class="chip">è²¯æ°´ç‡(%) 
      <input id="rate_min" type="number" min="0" max="100" value="0" style="width:70px;margin-left:6px;">ã€œ
      <input id="rate_max" type="number" min="0" max="100" value="100" style="width:70px;">
    </label>
    <fieldset class="chip" id="ops" style="border:none">
      <legend>ç®¡ç†ä½“åˆ¶</legend>
      <label><input type="checkbox" value="å›½" checked> å›½</label>
      <label><input type="checkbox" value="è‡ªæ²»ä½“" checked> è‡ªæ²»ä½“</label>
      <label><input type="checkbox" value="æ°´è³‡æºæ©Ÿæ§‹" checked> æ°´è³‡æºæ©Ÿæ§‹</label>
      <label><input type="checkbox" value="æ°‘é–“" checked> æ°‘é–“</label>
    </fieldset>
    <label class="chip"><input id="in_bbox" type="checkbox"> åœ°å›³ã§çµã‚Šè¾¼ã‚€</label>
    <fieldset class="chip" style="border:none">
      <legend>ä¸Šæ˜‡/ä¸‹é™</legend>
      <label><input id="rising" type="checkbox"> ç›´è¿‘ä¸Šæ˜‡</label>
      <label><input id="falling" type="checkbox"> ç›´è¿‘æ—¥ä¸‹é™</label>
      <label>24h |Î”| â‰¥ <input id="delta24_abs" type="number" value="0" min="0" step="0.5" style="width:70px;"> %</label>
    </fieldset>
    <button id="reset" class="btn">æ¡ä»¶ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="save-filter" class="btn" title="ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜">æ¡ä»¶ä¿å­˜</button>
    <button id="load-filter" class="btn" title="ä¿å­˜ã—ãŸãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’å¾©å…ƒ">æ¡ä»¶å¾©å…ƒ</button>
    <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="row" style="margin-left:8px;">
      <button class="btn-chip" id="q-low"   title="è²¯æ°´ç‡ < 40%">ä½æ°´ä½</button>
      <button class="btn-chip" id="q-rise"  title="24hÎ” â‰¥ +2%">ä¸Šæ˜‡</button>
      <button class="btn-chip" id="q-fall"  title="24hÎ” â‰¤ -2%">ä¸‹é™</button>
      <button class="btn-chip" id="q-tonegawa" title="åˆ©æ ¹å·æ°´ç³»">åˆ©æ ¹å·</button>
      <button class="btn-chip" id="q-yodogawa" title="æ·€å·æ°´ç³»">æ·€å·</button>
    </div>
    <!-- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
    <div class="row" style="margin-left:8px;">
      <button class="btn" id="export-csv">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn" id="export-json">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
  <button class="theme-toggle" id="theme-toggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">ğŸŒ™</button>
</header>

<!-- AdSense: ãƒˆãƒƒãƒ—ãƒãƒŠãƒ¼åºƒå‘Š -->
<div class="ad-container" style="max-width: 1800px; margin: 1.5rem auto;">
  <div style="width: 100%;">
    <div class="ad-label">ã‚¹ãƒãƒ³ã‚µãƒ¼</div>
    <!-- æ¨ªé•·ãƒãƒŠãƒ¼åºƒå‘Š (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–) -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-3008545198706381"
         data-ad-slot="2332961351"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
</div>

<!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="alerts" style="display:none;background:#fef3c7;border:1px solid #f59e0b;padding:12px;margin:12px;border-radius:8px;">
  <h4 style="margin:0 0 8px 0;color:#92400e;">âš ï¸ ã‚¢ãƒ©ãƒ¼ãƒˆ</h4>
  <div id="alert-list"></div>
</div>

<div id="main">
  <div id="map"></div>
  <div>
    <div class="row" style="justify-content:space-between;margin:0 0 6px 0">
      <div class="meta" id="summary">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="row">
        <label class="chip">ä¸¦ã³æ›¿ãˆ
          <select id="sort" style="margin-left:6px;">
            <option value="rate_asc">è²¯æ°´ç‡ ä½ã„ â†’ é«˜ã„</option>
            <option value="rate_desc">è²¯æ°´ç‡ é«˜ã„ â†’ ä½ã„</option>
            <option value="delta_desc">24hå¤‰åŒ– å¤§ãã„é †</option>
            <option value="updated_desc">æ›´æ–° æ–°ã—ã„é †</option>
          </select>
        </label>
      </div>
    </div>
    <div id="list"></div>
  </div>
</div>

<!-- AdSense: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸­åºƒå‘Š -->
<div class="ad-container" style="max-width: 1400px;">
  <div style="width: 100%;">
    <div class="ad-label">ã‚¹ãƒãƒ³ã‚µãƒ¼</div>
    <!-- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åºƒå‘Š -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-3008545198706381"
         data-ad-slot="2332961351"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
</div>

<div id="detail">
  <h3 id="detail-title">æ¨ç§»</h3>
  <canvas id="chart" height="160"></canvas>
</div>

<!-- AdSense: è¨˜äº‹å†…åºƒå‘Š -->
<div class="ad-container" style="max-width: 1400px;">
  <div style="width: 100%;">
    <div class="ad-label">ã‚¹ãƒãƒ³ã‚µãƒ¼</div>
    <!-- è¨˜äº‹å†…åºƒå‘Š -->
    <ins class="adsbygoogle"
         style="display:block; text-align:center;"
         data-ad-layout="in-article"
         data-ad-format="fluid"
         data-ad-client="ca-pub-3008545198706381"
         data-ad-slot="8095605684"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
</div>

<footer>
  å‡ºå…¸ï¼šå„è‡ªæ²»ä½“ã®å…¬é–‹ãƒ‡ãƒ¼ã‚¿ï¼ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ç­‰ï¼ˆã‚µã‚¤ãƒˆè¦ç´„é †å®ˆï¼‰ã€‚åœ°å›³ã‚¿ã‚¤ãƒ«ï¼šå›½åœŸåœ°ç†é™¢ã€‚<br/>
  è¡¨ç¤ºã¯å‚è€ƒå€¤ã§ã™ã€‚è¦³æ¸¬ãƒ»å–å¾—æ™‚åˆ»ã®ãšã‚Œã‚„æ¬ æ¸¬ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
</footer>

<!-- ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ç”¨ï¼‰ -->
<div id="mini-tip"></div>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<!-- Chart.js ã‚’å®‰å®šç‰ˆ(UMD)ã«å›ºå®š -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
let INDEX = [];
let map, bbox = null, chart;

// ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ã®çŠ¶æ…‹
const quick = { low:false, rise:false, fall:false, tonegawa:false, yodogawa:false };

// ---------- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ ----------
function initThemeToggle() {
  const toggle = document.getElementById('theme-toggle');
  const body = document.body;

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
  const savedTheme = localStorage.getItem('theme') || 'light';
  body.setAttribute('data-theme', savedTheme);
  toggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

  toggle.addEventListener('click', () => {
    const currentTheme = body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    body.setAttribute('data-theme', newTheme);
    toggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    localStorage.setItem('theme', newTheme);
  });
}

// ---------- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ----------
async function loadIndex(){
  const res = await fetch('./data/dams_index.json', {cache:'no-cache'});
  if(!res.ok){ document.getElementById('summary').textContent = 'dams_index.json ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“'; return; }
  INDEX = await res.json();
}

function initPrefOptions(){
  const prefs = [...new Set(INDEX.map(x=>x.pref))].sort();
  const sel = document.getElementById('pref');
  sel.innerHTML = prefs.map(p=>`<option value="${p}">${p}</option>`).join('');
}

function initRiverOptions(){
  const rivers = [...new Set(INDEX.map(x=>x.river).filter(r=>r))].sort();
  const sel = document.getElementById('river');
  sel.innerHTML = rivers.map(r=>`<option value="${r}">${r}</option>`).join('');
}

// ---------- ãƒ•ã‚£ãƒ«ã‚¿ ----------
function getFilters(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  const pref = Array.from(document.getElementById('pref').selectedOptions).map(o=>o.value);
  const river = Array.from(document.getElementById('river').selectedOptions).map(o=>o.value);
  const rateMin = +document.getElementById('rate_min').value || 0;
  const rateMax = +document.getElementById('rate_max').value || 100;
  const inBbox = document.getElementById('in_bbox').checked;
  const rising = document.getElementById('rising').checked || quick.rise;
  const falling = document.getElementById('falling').checked || quick.fall;
  const delta24_abs = +document.getElementById('delta24_abs').value || 0;

  const opsChecked = Array.from(document.querySelectorAll('#ops input[type="checkbox"]'))
    .filter(i => i.checked)
    .map(i=>i.value);

  return { q, pref, river, rateMin, rateMax, inBbox, rising, falling, delta24_abs, opsChecked };
}

function applyFilters(rows, f){
  let r = rows.slice();
  if (f.pref.length) r = r.filter(x => f.pref.includes(x.pref));
  if (f.river.length) r = r.filter(x => f.river.includes(x.river));
  r = r.filter(x => typeof x.rate_pct==='number' && x.rate_pct>=f.rateMin && x.rate_pct<=f.rateMax);
  if (f.opsChecked.length) r = r.filter(x => f.opsChecked.includes(x.operator_group));
  if (quick.low) r = r.filter(x => (x.rate_pct ?? 101) < 40);
  if (f.rising)  r = r.filter(x => (x.delta_pct_24h ?? x.delta_pct_last ?? 0) >= 2);
  if (f.falling) r = r.filter(x => (x.delta_pct_24h ?? x.delta_pct_last ?? 0) <= -2);
  if (f.delta24_abs > 0) r = r.filter(x => Math.abs(x.delta_pct_24h ?? 0) >= f.delta24_abs);
  if (f.q) r = r.filter(x => (x.name||'').toLowerCase().includes(f.q) || (x.river||'').toLowerCase().includes(f.q));
  if (quick.tonegawa) r = r.filter(x => (x.river||'').includes('åˆ©æ ¹å·'));
  if (quick.yodogawa) r = r.filter(x => (x.river||'').includes('æ·€å·'));
  if (f.inBbox && bbox){
    const [minX,minY,maxX,maxY] = bbox;
    r = r.filter(x => x.lon>=minX && x.lon<=maxX && x.lat>=minY && x.lat<=maxY);
  }
  return r;
}

function sortRows(rows, key){
  const r = rows.slice();
  if (key==='rate_asc') r.sort((a,b)=>(a.rate_pct??999)-(b.rate_pct??999));
  if (key==='rate_desc') r.sort((a,b)=>(b.rate_pct??-999)-(a.rate_pct??-999));
  if (key==='delta_desc') r.sort((a,b)=>(Math.abs(b.delta_pct_24h??0))-(Math.abs(a.delta_pct_24h??0)));
  if (key==='updated_desc') r.sort((a,b)=> new Date(b.updated_at) - new Date(a.updated_at));
  return r;
}

// ---------- ãƒªã‚¹ãƒˆï¼ˆå·¦ãƒ†ã‚­ã‚¹ãƒˆï¼å³ãƒŸãƒ‹ã‚°ãƒ©ãƒ•ï¼‰ ----------
function renderList(rows){
  const el = document.getElementById('list');
  const sortKey = document.getElementById('sort').value;
  const sorted = sortRows(rows, sortKey);

  document.getElementById('summary').textContent = `è¡¨ç¤ºä»¶æ•°: ${sorted.length} / ç·æ•°: ${INDEX.length}`;

  el.innerHTML = sorted.slice(0, 400).map(x => `
    <div class="item">
      <div class="row-line">
        <div>
          <h4 style="margin:0">
            ${x.name}
            <span class="badge">${x.pref}</span>
            <span class="badge">${x.operator_group}</span>
          </h4>
          <div class="meta">
            è²¯æ°´ç‡: <b>${x.rate_pct ?? '-'}</b>%ã€€
            24hÎ”: <b>${x.delta_pct_24h ?? '-'}</b>%ã€€
            æ›´æ–°: ${x.updated_at ?? '-'}
          </div>
          <div class="row" style="margin-top:6px">
            <button class="btn" onclick="openDetail('${x.dam_id}','${x.name}')">è©³ç´°ã‚°ãƒ©ãƒ•</button>
            <button class="btn" onclick="flyTo(${x.lon},${x.lat})">åœ°å›³ã§è¦‹ã‚‹</button>
          </div>
        </div>
        <canvas class="mini" width="240" height="42" data-damid="${x.dam_id}" title="ç›´è¿‘ã®æ¨ç§»"></canvas>
      </div>
    </div>
  `).join('');

  updateMapMarkers(sorted);
  setupMiniObserver(); // å¯è¦–è¡Œã‹ã‚‰é †ã«ãƒŸãƒ‹ã‚°ãƒ©ãƒ•æç”»
}

// ---------- è©³ç´°ã‚°ãƒ©ãƒ• ----------
async function openDetail(damId, name){
  document.getElementById('detail-title').textContent = `æ¨ç§»ï¼š${name}`;
  const url = `./data/history/${damId}.ndjson`;
  const res = await fetch(url, {cache:'no-cache'});
  if(!res.ok){ alert('å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const text = await res.text();
  const rows = text.trim().split("\n").map(l=>JSON.parse(l));
  rows.sort((a,b)=> new Date(a.observed_at) - new Date(b.observed_at));
  const labels = rows.map(r=> r.observed_at);
  const data = rows.map(r=> r.rate_pct ?? null);

  if(chart) chart.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'è²¯æ°´ç‡(%)', data, spanGaps: true }] },
    options: {
      interaction: { mode: 'nearest', intersect: false },
      scales: { y: { suggestedMin: 0, suggestedMax: 100 } }
    }
  });
}

// ---------- åœ°å›³ ----------
function initMap(){
  map = new maplibregl.Map({
    container: 'map',
    style: {
      "version": 8,
      "sources": {
        "gsi": {
          "type": "raster",
          "tiles": ["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"],
          "tileSize": 256,
          "attribution": "åœ°å›³:å›½åœŸåœ°ç†é™¢"
        }
      },
      "layers": [{"id":"gsi","type":"raster","source":"gsi"}]
    },
    center: [139.6917,35.6895], zoom: 4.5
  });

  map.on('load', ()=>{
    map.addSource('dams', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
    map.addLayer({
      id:'dams-circle',
      type:'circle',
      source:'dams',
      paint:{
        'circle-radius': 5,
        'circle-color': ['case',
          ['has','rate'],
          ['interpolate',['linear'], ['get','rate'],
            0,'#ef4444', 40,'#ef4444', 60,'#f97316', 80,'#f59e0b', 100,'#10b981'
          ],
          '#9ca3af'
        ],
        'circle-stroke-color':'#334155','circle-stroke-width': 0.5
      }
    });
    map.on('moveend', ()=>{
      const b = map.getBounds();
      bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()];
      if(document.getElementById('in_bbox').checked) render();
    });
    render(); // åˆå›
  });

  map.on('click','dams-circle',(e)=>{
    const f = e.features[0];
    openDetail(f.properties.dam_id, f.properties.name);
  });
}

function updateMapMarkers(rows){
  if (!map || !map.getSource('dams')) return;
  const features = rows.map(x=> ({
    type:'Feature',
    geometry:{ type:'Point', coordinates:[x.lon, x.lat] },
    properties:{ dam_id:x.dam_id, name:x.name, rate:x.rate_pct }
  }));
  map.getSource('dams').setData({ type:'FeatureCollection', features });
}

function flyTo(lon,lat){ map.flyTo({ center:[lon,lat], zoom: 10 }); }

// ---------- ãƒŸãƒ‹ã‚°ãƒ©ãƒ•ï¼ˆè‰²åˆ†ã‘ãƒ»ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãƒ»é…å»¶æç”»ï¼‰ ----------
const historyCache = new Map(); // dam_id -> [{t:Date, y:number}, ...]
let miniObserver;
const tip = document.getElementById('mini-tip');

function setupMiniObserver(){
  if (miniObserver) miniObserver.disconnect();
  miniObserver = new IntersectionObserver(entries=>{
    for(const e of entries){
      if(e.isIntersecting){
        const cv = e.target;
        const damId = cv.dataset.damid;
        drawMiniFor(damId, cv);
        miniObserver.unobserve(cv);
      }
    }
  }, {root: document.getElementById('list'), threshold: 0.1});
  document.querySelectorAll('canvas.mini').forEach(cv => miniObserver.observe(cv));
}

async function drawMiniFor(damId, canvas){
  if(!historyCache.has(damId)){
    try{
      const url = `./data/history/${damId}.ndjson`;
      const res = await fetch(url, {cache:'no-cache'});
      if(!res.ok){ return; }
      const text = await res.text();
      const rows = text.trim().split("\n").map(l=>JSON.parse(l))
        .filter(r => typeof r.rate_pct === 'number')
        .sort((a,b)=> new Date(a.observed_at) - new Date(b.observed_at));
      const N = 30;
      const tail = rows.slice(-N).map(r=>({ t:new Date(r.observed_at), y:r.rate_pct }));
      historyCache.set(damId, tail);
    }catch(e){ console.warn('mini fetch failed', damId, e); return; }
  }
  const series = historyCache.get(damId);
  if(!series || series.length===0) return;
  sparkline(canvas, series);
  attachMiniTooltip(canvas, series);
}

// ç·šè‰²ã‚’è²¯æ°´ç‡ã§å¤‰ãˆã‚‹ï¼ˆæœ€æ–°å€¤ã§åˆ¤å®šï¼‰
function colorByLevel(p){
  if (p==null) return '#9ca3af';
  if (p<40) return '#ef4444';
  if (p<60) return '#f97316';
  if (p<80) return '#f59e0b';
  return '#10b981';
}

// ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³æç”»ï¼ˆseries = [{t:Date, y:number}...]ï¼‰
// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ããƒ¢ãƒ€ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³
function sparkline(canvas, series, animate = true){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const ys = series.map(p=>p.y).filter(v=>typeof v==='number');
  if(ys.length===0) return;

  const ymin = Math.min(...ys), ymax = Math.max(...ys);
  const pad = 4;
  const xStep = (W - pad*2) / Math.max(1, series.length - 1);
  const yScale = (H - pad*2) / (ymax - ymin || 1);

  // ç·šï¼ˆè‰²åˆ†ã‘ï¼‰
  const last = series[series.length-1]?.y ?? null;
  const stroke = colorByLevel(last);

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æç”»é–¢æ•°
  function draw(progress) {
    ctx.clearRect(0,0,W,H);

    // è£œåŠ©ç·šï¼ˆä¸­å¤®å€¤ï¼‰
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#e5e7eb';
    ctx.beginPath(); ctx.moveTo(0, H/2); ctx.lineTo(W, H/2); ctx.stroke();

    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
    const gradient = ctx.createLinearGradient(0, 0, W, 0);
    gradient.addColorStop(0, stroke + '80');
    gradient.addColorStop(1, stroke);

    // ç·šã‚’æç”»ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã«å¿œã˜ã¦ï¼‰
    const visiblePoints = Math.ceil(series.length * progress);
    if (visiblePoints > 0) {
      ctx.lineWidth = 2.2;
      ctx.strokeStyle = gradient;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();

      for(let i = 0; i <= visiblePoints && i < series.length; i++) {
        const p = series[i];
        const x = pad + i * xStep;
        const y = H - pad - (p.y - ymin) * yScale;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // ã‚°ãƒ­ãƒ¼åŠ¹æœ
      ctx.shadowBlur = 6;
      ctx.shadowColor = stroke;
      ctx.stroke();
      ctx.shadowBlur = 0;

      // ç›´è¿‘ç‚¹ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Œäº†æ™‚ã®ã¿ï¼‰
      if (progress >= 1 && series.length > 0) {
        const xL = pad + (series.length-1)*xStep;
        const yL = H - pad - (last - ymin) * yScale;
        ctx.fillStyle = stroke;
        ctx.shadowBlur = 8;
        ctx.shadowColor = stroke;
        ctx.beginPath();
        ctx.arc(xL,yL,3.5,0,Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
      }
    }
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  if (animate && !canvas._animated) {
    canvas._animated = true;
    let start = null;
    const duration = 600;

    function animateFrame(timestamp) {
      if (!start) start = timestamp;
      const elapsed = timestamp - start;
      const progress = Math.min(elapsed / duration, 1);

      // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆease-out-cubicï¼‰
      const eased = 1 - Math.pow(1 - progress, 3);
      draw(eased);

      if (progress < 1) {
        requestAnimationFrame(animateFrame);
      }
    }

    requestAnimationFrame(animateFrame);
  } else {
    draw(1);
  }

  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åº§æ¨™å¤‰æ›æƒ…å ±ã‚’ä¿å­˜ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ï¼‰
  canvas._spark = { pad, xStep, ymin, ymax, yScale, series };
}

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆæœ€å¯„ã‚Šç‚¹ï¼‰
function attachMiniTooltip(canvas, series){
  canvas.onmousemove = (ev)=>{
    if(!canvas._spark) return;
    const r = canvas.getBoundingClientRect();
    const x = ev.clientX - r.left;
    const { pad, xStep } = canvas._spark;
    const idx = Math.max(0, Math.min(series.length-1, Math.round((x - pad)/xStep)));
    const p = series[idx];
    if(!p) return;

    tip.style.display = 'block';
    tip.textContent = `${p.t.toLocaleString()} / ${p.y.toFixed(1)}%`;
    tip.style.left = `${ev.clientX}px`;
    tip.style.top  = `${ev.clientY}px`;
  };
  canvas.onmouseleave = ()=>{ tip.style.display = 'none'; };
}

// ---------- ã‚¤ãƒ™ãƒ³ãƒˆ & ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ----------
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

function bindEvents(){
  ['q','pref','river','rate_min','rate_max','in_bbox','rising','falling','delta24_abs','sort']
    .forEach(id => document.getElementById(id).addEventListener('input', debounce(render, 200)));

  document.getElementById('reset').addEventListener('click', ()=>{
    document.getElementById('q').value = '';
    Array.from(document.getElementById('pref').options).forEach(o=>o.selected=false);
    Array.from(document.getElementById('river').options).forEach(o=>o.selected=false);
    document.getElementById('rate_min').value = 0;
    document.getElementById('rate_max').value = 100;
    document.getElementById('in_bbox').checked = false;
    document.getElementById('rising').checked = false;
    document.getElementById('falling').checked = false;
    document.getElementById('delta24_abs').value = 0;
    quick.low = quick.rise = quick.fall = quick.tonegawa = quick.yodogawa = false;
    document.querySelectorAll('.btn-chip').forEach(b=>b.classList.remove('active'));
    render();
  });

  // ãƒ•ã‚£ãƒ«ã‚¿ä¿å­˜ãƒ»å¾©å…ƒ
  document.getElementById('save-filter').addEventListener('click', ()=>{
    const filters = getFilters();
    const state = {
      q: document.getElementById('q').value,
      pref: filters.pref,
      river: filters.river,
      rate_min: filters.rateMin,
      rate_max: filters.rateMax,
      rising: document.getElementById('rising').checked,
      falling: document.getElementById('falling').checked,
      delta24_abs: filters.delta24_abs,
      quick: {...quick}
    };
    localStorage.setItem('dam_filters', JSON.stringify(state));
    alert('ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  });

  document.getElementById('load-filter').addEventListener('click', ()=>{
    const saved = localStorage.getItem('dam_filters');
    if(!saved){ alert('ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const state = JSON.parse(saved);

    document.getElementById('q').value = state.q || '';
    Array.from(document.getElementById('pref').options).forEach(o=>o.selected = state.pref.includes(o.value));
    Array.from(document.getElementById('river').options).forEach(o=>o.selected = state.river.includes(o.value));
    document.getElementById('rate_min').value = state.rate_min || 0;
    document.getElementById('rate_max').value = state.rate_max || 100;
    document.getElementById('rising').checked = state.rising || false;
    document.getElementById('falling').checked = state.falling || false;
    document.getElementById('delta24_abs').value = state.delta24_abs || 0;

    Object.assign(quick, state.quick || {});
    document.querySelectorAll('.btn-chip').forEach(b=>b.classList.remove('active'));
    if(quick.low) document.getElementById('q-low').classList.add('active');
    if(quick.rise) document.getElementById('q-rise').classList.add('active');
    if(quick.fall) document.getElementById('q-fall').classList.add('active');
    if(quick.tonegawa) document.getElementById('q-tonegawa').classList.add('active');
    if(quick.yodogawa) document.getElementById('q-yodogawa').classList.add('active');

    alert('ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
    render();
  });

  // ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿
  const qLow = document.getElementById('q-low');
  const qRise = document.getElementById('q-rise');
  const qFall = document.getElementById('q-fall');
  const qTone = document.getElementById('q-tonegawa');
  const qYodo = document.getElementById('q-yodogawa');

  qLow.onclick  = ()=>{ quick.low  = !quick.low;  qLow.classList.toggle('active');  render(); };
  qRise.onclick = ()=>{ quick.rise = !quick.rise; qRise.classList.toggle('active'); render(); };
  qFall.onclick = ()=>{ quick.fall = !quick.fall; qFall.classList.toggle('active'); render(); };
  qTone.onclick = ()=>{ quick.tonegawa = !quick.tonegawa; qTone.classList.toggle('active'); render(); };
  qYodo.onclick = ()=>{ quick.yodogawa = !quick.yodogawa; qYodo.classList.toggle('active'); render(); };
}

function render(){
  const f = getFilters();
  const rows = applyFilters(INDEX, f);
  renderList(rows);
}

// ---------- ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ ----------
function checkAlerts(rows){
  const alerts = [];

  for(const row of rows){
    // ä½æ°´ä½ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆè²¯æ°´ç‡ < 30%ï¼‰
    if(typeof row.rate_pct === 'number' && row.rate_pct < 30){
      alerts.push({
        type: 'low',
        message: `${row.name}ï¼ˆ${row.pref}ï¼‰ã®è²¯æ°´ç‡ãŒ${row.rate_pct}%ã¨ä½ä¸‹ã—ã¦ã„ã¾ã™`,
        dam: row
      });
    }

    // æ€¥æ¿€ãªæ¸›å°‘ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ24hå¤‰åŒ– < -5%ï¼‰
    if(typeof row.delta_pct_24h === 'number' && row.delta_pct_24h < -5){
      alerts.push({
        type: 'rapid_decrease',
        message: `${row.name}ï¼ˆ${row.pref}ï¼‰ã®è²¯æ°´ç‡ãŒ24æ™‚é–“ã§${row.delta_pct_24h}%æ¸›å°‘ã—ã¦ã„ã¾ã™`,
        dam: row
      });
    }

    // æ€¥æ¿€ãªå¢—åŠ ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ24hå¤‰åŒ– > +10%ï¼‰
    if(typeof row.delta_pct_24h === 'number' && row.delta_pct_24h > 10){
      alerts.push({
        type: 'rapid_increase',
        message: `${row.name}ï¼ˆ${row.pref}ï¼‰ã®è²¯æ°´ç‡ãŒ24æ™‚é–“ã§${row.delta_pct_24h}%å¢—åŠ ã—ã¦ã„ã¾ã™`,
        dam: row
      });
    }
  }

  displayAlerts(alerts);
  return alerts;
}

function displayAlerts(alerts){
  const alertEl = document.getElementById('alerts');
  const listEl = document.getElementById('alert-list');

  if(alerts.length === 0){
    alertEl.style.display = 'none';
    return;
  }

  alertEl.style.display = 'block';
  listEl.innerHTML = alerts.map(a => `
    <div style="margin-bottom:6px;padding:6px;background:#fff;border-radius:4px;">
      <span style="color:#92400e;">${a.message}</span>
    </div>
  `).join('');
}

// ---------- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ----------
function exportToCSV(rows){
  const headers = ['ãƒ€ãƒ ID', 'ãƒ€ãƒ å', 'éƒ½é“åºœçœŒ', 'æ²³å·', 'ç®¡ç†ä½“åˆ¶', 'ç·¯åº¦', 'çµŒåº¦', 'è²¯æ°´ç‡(%)', 'æ°´ä½(m)', '24hå¤‰åŒ–(%)', 'æ›´æ–°æ—¥æ™‚'];
  const csvRows = [headers.join(',')];

  for(const row of rows){
    const values = [
      row.dam_id || '',
      `"${(row.name || '').replace(/"/g, '""')}"`,
      row.pref || '',
      `"${(row.river || '').replace(/"/g, '""')}"`,
      row.operator_group || '',
      row.lat || '',
      row.lon || '',
      row.rate_pct ?? '',
      row.level_m ?? '',
      row.delta_pct_24h ?? '',
      row.updated_at || ''
    ];
    csvRows.push(values.join(','));
  }

  const csv = csvRows.join('\n');
  const bom = '\uFEFF';  // UTF-8 BOM for Excel
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `dam_data_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}

function exportToJSON(rows){
  const json = JSON.stringify({
    exported_at: new Date().toISOString(),
    count: rows.length,
    records: rows
  }, null, 2);

  const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `dam_data_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);
}

function bindExportEvents(){
  document.getElementById('export-csv').addEventListener('click', ()=>{
    const f = getFilters();
    const rows = applyFilters(INDEX, f);
    exportToCSV(rows);
  });

  document.getElementById('export-json').addEventListener('click', ()=>{
    const f = getFilters();
    const rows = applyFilters(INDEX, f);
    exportToJSON(rows);
  });
}

// ---------- èµ·å‹• ----------
(async function start(){
  initThemeToggle();  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
  await loadIndex();
  initPrefOptions();
  initRiverOptions();
  initMap();
  bindEvents();
  bindExportEvents();
  checkAlerts(INDEX);  // èµ·å‹•æ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
})();
</script>

<!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ (JSON-LD) for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ",
  "alternateName": "DamWatch Japan",
  "url": "https://okaspo.github.io/dam-aggregator/",
  "description": "å…¨å›½200ä»¥ä¸Šã®ãƒ€ãƒ ã®è²¯æ°´ç‡ãƒ»æ°´ä½ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã™ã‚‹ãƒ€ãƒ æƒ…å ±ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚µã‚¤ãƒˆ",
  "keywords": "ãƒ€ãƒ ,è²¯æ°´ç‡,æ°´ä½,ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ,ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°,é˜²ç½,æ°´è³‡æº",
  "inLanguage": "ja",
  "creator": {
    "@type": "Organization",
    "name": "ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ"
  },
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://okaspo.github.io/dam-aggregator/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "ãƒ€ãƒ ã‚¦ã‚©ãƒƒãƒ - ãƒ€ãƒ è²¯æ°´ç‡ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°",
  "url": "https://okaspo.github.io/dam-aggregator/",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Web Browser",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "JPY"
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "ratingCount": "100",
    "bestRating": "5",
    "worstRating": "1"
  },
  "description": "å…¨å›½200ä»¥ä¸Šã®ãƒ€ãƒ ã®è²¯æ°´ç‡ãƒ»æ°´ä½ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã€‚å›½åœŸäº¤é€šçœã€æ°´è³‡æºæ©Ÿæ§‹ã€è‡ªæ²»ä½“ç®¡ç†ãƒ€ãƒ ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åœ°å›³ã¨ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã€‚é˜²ç½æƒ…å ±ã¨ã—ã¦æ´»ç”¨å¯èƒ½ã€‚",
  "featureList": [
    "å…¨å›½200+ãƒ€ãƒ ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿",
    "ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–åœ°å›³è¡¨ç¤º",
    "æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•è¡¨ç¤º",
    "è²¯æ°´ç‡ãƒ»æ°´ä½ãƒ»æµå…¥é‡ãƒ»æ”¾æµé‡ã®ç›£è¦–",
    "ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ",
    "CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½",
    "ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½",
    "ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»æ¤œç´¢æ©Ÿèƒ½"
  ],
  "screenshot": "https://okaspo.github.io/dam-aggregator/screenshot.png"
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "ãƒ›ãƒ¼ãƒ ",
      "item": "https://okaspo.github.io/dam-aggregator/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "å…¨å›½ãƒ€ãƒ ãƒãƒƒãƒ—",
      "item": "https://okaspo.github.io/dam-aggregator/#map"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "ãƒ€ãƒ ãƒªã‚¹ãƒˆ",
      "item": "https://okaspo.github.io/dam-aggregator/#list"
    }
  ]
}
</script>

</body>
</html>
