name: ingest-and-publish
on:
  schedule:
    # 1日4回のデータ取得（6時間ごと）
    - cron: '5 21 * * *'   # UTC 21:05 = JST 06:05 (朝)
    - cron: '5 3 * * *'    # UTC 03:05 = JST 12:05 (昼)
    - cron: '5 9 * * *'    # UTC 09:05 = JST 18:05 (夕)
    - cron: '5 14 * * *'   # UTC 14:05 = JST 23:05 (夜)
  workflow_dispatch: {}    # 手動実行ボタン

permissions:
  contents: write                  # gh-pages への書き込み

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 全国のダムデータ取得
      - name: Fetch all dams
        run: python scripts/fetch_all_dams.py

      - name: Append history
        run: python scripts/append_history.py

      - name: Build index
        run: python scripts/build_index.py

      - name: Commit data
        run: |
          git config user.name "bot"
          git config user.email "bot@example.com"
          git add public/data
          git commit -m "update data" || echo "no changes"
          git push

      # public/ を gh-pages ブランチにデプロイ
      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          publish_dir: ./public
          github_token: ${{ secrets.GITHUB_TOKEN }}
